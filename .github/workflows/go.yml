name: Engine Build & Release

on: [push]

jobs:

  build:
    name: Build Engine Linux & Darwin
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    - name: Set up Go
      uses: actions/setup-go@v3
      with:
        go-version: 1.18

    # Build Linux AMD64
    - name: Build Linux AMD64 CLI
      run: env GOOS=linux GOARCH=amd64 go build -o owl ./bin/cli.go

    - name: Build Linux AMD64 Server
      run: env GOOS=linux GOARCH=amd64 go build -o server ./main.go

    - name: Create Artefact Linux AMD64
      run: |
        mkdir -p engine-artifact
        mv flows engine-artifact/flows
        mv logs engine-artifact/logs
        mv resources engine-artifact/resources
        mv LICENSE engine-artifact/LICENSE
        mv README.md engine-artifact/README.md
        mv owl engine-artifact/owl
        mv server engine-artifact/server

    - uses: montudor/action-zip@v1
      with:
        args: zip -qq -r engine-linux-amd64.zip engine-artifact

    - uses: "marvinpinto/action-automatic-releases@latest"
      with:
        repo_token: "${{ secrets.GITHUB_TOKEN }}"
        automatic_release_tag: "engine-linux-amd64"
        prerelease: false
        files: |
          engine-linux-amd64.zip

    # Build Linux 386
    - name: Build Linux 386 CLI
      run: env GOOS=linux GOARCH=386 go build -o owl ./bin/cli.go

    - name: Build Linux 386 Server
      run: env GOOS=linux GOARCH=386 go build -o server ./main.go

    - name: Create Artefact Linux 386
      run: |
        mv owl engine-artifact/owl
        mv server engine-artifact/server

    - uses: montudor/action-zip@v1
      with:
        args: zip -qq -r engine-linux-386.zip engine-artifact

    - uses: "marvinpinto/action-automatic-releases@latest"
      with:
        repo_token: "${{ secrets.GITHUB_TOKEN }}"
        automatic_release_tag: "engine-linux-386"
        prerelease: false
        files: |
          engine-linux-386.zip

    # Build Darwin AMD64
    - name: Build Darwin AMD64 CLI
      run: env GOOS=darwin GOARCH=amd64 go build -o owl ./bin/cli.go

    - name: Build Darwin AMD64 Server
      run: env GOOS=darwin GOARCH=amd64 go build -o server ./main.go

    - name: Create Artefact Darwin AMD64
      run: |
        mv owl engine-artifact/owl
        mv server engine-artifact/server

    - uses: montudor/action-zip@v1
      with:
        args: zip -qq -r engine-darwin-amd64.zip engine-artifact

    - uses: "marvinpinto/action-automatic-releases@latest"
      with:
        repo_token: "${{ secrets.GITHUB_TOKEN }}"
        automatic_release_tag: "engine-darwin-amd64"
        prerelease: false
        files: |
          engine-darwin-amd64.zip
